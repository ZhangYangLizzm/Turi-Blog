# Vite Plugins

## 图片压缩

`yarn add vite-plugin-imagemin`

```ts
//vite.config.ts
import imagemin from 'vite-plugin-imagemin'

plugins: [
      imagemin(),
      ...
 ]
```

## 打包文件大小可视化

`yarn add rollup-plugin-visualizer`

```ts
//vite.config.ts
import visualizer from 'rollup-plugin-visualizer'

plugins: [
      visualizer(),
      ...
 ]
```

打包会生成`stats.html`打开即可

## https

对基本使用的配置需求来说，可以添加 @vitejs/plugin-basic-ssl 到项目插件中，会自动创建和缓存一个自签名的证书。

`yarn add @vitejs/plugin-basic-ssl`

```ts
// vite.config.js
import basicSsl from "@vitejs/plugin-basic-ssl";

export default {
  plugins: [basicSsl()],
};
```

## 根据 assets 中的图片文件生成 imagekeys

```ts
import { Plugin, normalizePath } from "vite";
import * as glob from "glob";
import * as path from "path";
import * as fs from "fs";

interface Options {
  extensions: string[];
  outputFilePath: string;
}

export default function assetsToTs(options: Options): Plugin {
  const { extensions, outputFilePath } = options;
  return {
    name: "assets-to-ts",
    async config() {
      const pattern = `**/*.{${extensions.join(",")}}`;
      const files = glob.sync(pattern, { cwd: "src/assets/images" });
      const assets = {};
      files.forEach((file) => {
        const normalFilePath = normalizePath(file);
        const key = normalFilePath.replace(/\.(png|jpe?g|gif|svg)$/, "");
        const parts = key.split("/");
        let obj = assets;
        for (let i = 0; i < parts.length - 1; i++) {
          const part = toCamelCase(parts[i]);
          if (!obj[part]) {
            obj[part] = {};
          }
          obj = obj[part];
        }
        const camelCaseKey = toCamelCase(parts[parts.length - 1]);
        obj[camelCaseKey] = `/src/assets/images/${normalFilePath}`;
      });
      const content = `// This file is generated by the Vite plugin "assets-to-ts"
// DO NOT MODIFY THIS FILE MANUALLY

const ImageAssets = ${formatObject(assets)};

export default ImageAssets;`;

      fs.writeFileSync(path.resolve(outputFilePath), content);
    },
  };
}

/**
 * 将对象格式化为 TypeScript 代码中可用的字符串。
 *
 * @param obj 要格式化的对象
 * @param indent 每一级缩进的空格数，默认为 ""（即不缩进）
 * @returns 返回格式化后的字符串
 * @example  
 * swiper: {
      swipImg04: '@/assets/home/swiper/swip_img04.png',
      swipImg03: '@/assets/home/swiper/swip_img03.png',
      swipImg02: '@/assets/home/swiper/swip_img02.png',
      swipImg01: '@/assets/home/swiper/swip_img01.png'
    }
 */
// eslint-disable-next-line @typescript-eslint/no-explicit-any
function formatObject(obj: { [key: string]: any }, indent = ""): string {
  const lines = [];
  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === "object") {
      lines.push(`${indent}${key}: ${formatObject(value, `${indent}  `)},`);
    } else {
      lines.push(`${indent}${key}: '${value}',`);
    }
  }
  return `{\n${lines.join("\n")}\n${indent.substr(2)}}`;
}

/**
 *
 * @param str 输入的字符串
 * @returns 驼峰命名的字符串
 * @example
 * sec-img ---> secImg
 */
function toCamelCase(str: string): string {
  return str.replace(/[-_]+(.)/g, (_, letter) => letter.toUpperCase());
}
```

使用方法

```ts
import assetsToKeys from "./vite-plugin/imgaePlugin";
//vite.config.ts
plugins: [
      assetsToKeys({
      extensions: ["png", "jpg", "jpeg", "gif", "svg"],
      outputFilePath: "src/assets/index.ts",
    }),
      ...
 ]
```
